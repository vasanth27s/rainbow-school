<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Rainbow School ‚Äî Payment Portal (Responsive, Corporate)</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- jsPDF for PDF invoice generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Razorpay checkout (test/demo) -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <meta name="theme-color" content="#ffffff" />
  <meta name="description" content="Rainbow School ‚Äî modern, accessible, corporate-style responsive payment portal and invoice generator." />

  <style>
    /* ==========================================================
       Rainbow School ‚Äî Payment Portal
       Purpose: polished, accessible, responsive layout for PC, laptop, tablet, mobile
       Author: ChatGPT (as innovation coach) ‚Äî single-file production-ready demo
       ========================================================== */

    :root{
      --primary: #0f62fe;      /* deep corporate blue */
      --primary-2: #5B8DEF;    /* accent blue */
      --accent: #FF8A65;       /* orange accent */
      --muted: #64748b;        /* neutral */
      --bg: #f6f9fc;           /* page background */
      --card: #ffffff;         /* card background */
      --soft: rgba(15,38,70,0.04);
      --radius: 14px;
      --glass: rgba(255,255,255,0.7);
      --max-width: 1200px;
      --shadow-1: 0 6px 28px rgba(14,30,80,0.06);
      --shadow-2: 0 12px 40px rgba(14,30,80,0.08);
      font-family: Inter, Poppins, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }

    /* Reset & base */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,var(--bg),#eef6ff);color:#05203a;line-height:1.45;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
      -webkit-text-size-adjust:100%;
    }

    a{color:var(--primary);text-decoration:none}
    a:focus{outline:3px solid rgba(15,98,254,0.12);outline-offset:3px}

    .container{max-width:var(--max-width);margin:22px auto;padding:18px;}

    /* topbar */
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(90deg,#ffffff,#fbfdff);box-shadow:var(--shadow-1);border:1px solid rgba(12,51,150,0.03)}
    .brand{display:flex;gap:12px;align-items:center}
    .mark{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800;color:white;font-size:20px;background:linear-gradient(135deg,var(--primary),#00b4ff);box-shadow:0 6px 18px rgba(9,33,91,0.08)}
    .brand h1{margin:0;font-size:18px}
    .brand p{margin:0;font-size:12px;color:var(--muted);font-weight:600}
.top-actions {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
  font-family: 'Inter', sans-serif;
}

.top-actions .phone {
  font-weight: 600;
  color: #08306b;
  font-size: 13px;
}

.top-actions .contact {
  font-size: 12px;
  color: #555;
  font-weight: 500;
}

.chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(91,141,239,0.05);
  border: 1px solid rgba(11,88,229,0.08);
  font-weight: 600;
  font-size: 12px;
  color: #08306b;
  text-align: center;
  white-space: nowrap;
}

/* Force same appearance across all devices */
* {
  -webkit-text-size-adjust: none;
  text-size-adjust: none;
}

    /* receipt badge added */
    .receipt-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:linear-gradient(90deg,rgba(15,98,254,0.08),rgba(91,141,239,0.03));border:1px solid rgba(11,88,229,0.06);font-weight:800;color:var(--primary);font-size:13px}
    .receipt-badge small{color:var(--muted);font-weight:600;font-size:11px}

    /* layout */
    .layout{display:grid;grid-template-columns:1fr 420px;gap:20px;margin-top:18px;align-items:start}

    /* cards */
    .card{background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:var(--shadow-2);border:1px solid rgba(12,51,150,0.03)}
    .card h2{margin:0 0 10px 0;font-size:20px}
    .muted{color:var(--muted);font-size:13px}

    /* hero left content */
    .school-info{display:flex;gap:14px}
    .school-body{flex:1}
    .school-body h3{margin:0 0 8px 0}
    .meta-list{display:flex;gap:12px;flex-wrap:wrap}
    .meta{background:linear-gradient(90deg,#ffffff,#fbfdff);padding:10px 12px;border-radius:10px;border:1px solid rgba(12,51,150,0.03);font-weight:600}

    /* payment form (right column) */
    .payment-panel{position:sticky;top:22px}
    .field{display:flex;flex-direction:column;margin-bottom:10px}
    label{font-size:13px;margin-bottom:6px;color:var(--muted);font-weight:700}
    input[type="text"], input[type="number"], input[type="date"], select, textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #e9f0ff;background:#fff;font-size:14px}
    input:focus, select:focus, textarea:focus{outline:none;box-shadow:0 4px 18px rgba(11,88,229,0.06);border-color:var(--primary)}

    .row{display:flex;gap:10px}
    .row .col{flex:1}

    .payment-methods{display:flex;gap:8px;flex-wrap:wrap}
    .pm{padding:10px 14px;border-radius:10px;border:1px solid #e6eefb;cursor:pointer;font-weight:700;background:linear-gradient(180deg,#fff,#fbfdff)}
    .pm.active{background:linear-gradient(90deg,rgba(91,141,239,0.12),rgba(255,138,101,0.06));border-color:var(--primary);box-shadow:0 8px 24px rgba(11,88,229,0.04)}

    .qr-box{border:1px dashed #e6eefb;border-radius:10px;padding:14px;text-align:center}

    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-ghost{background:transparent;border:1px solid rgba(11,88,229,0.06)}
    .btn:active{transform:translateY(1px)}

    .invoice-ready{margin-top:12px;padding:12px;border-radius:10px;background:#f0fff6;border:1px solid #e8fbec;color:#03543f;font-weight:700}

    /* responsive / smaller devices */
    @media (max-width:1100px){
      .layout{grid-template-columns:1fr 380px}
    }
    @media (max-width:980px){
      .layout{grid-template-columns:1fr}
      .payment-panel{position:relative;top:auto}
    }

    @media (max-width:560px){
      .mark{width:48px;height:48px;font-size:18px}
      .topbar{padding:10px}
      .container{padding:12px}
      input[type="text"], input[type="number"], select{padding:10px}
      .chip{padding:6px 10px}
      .receipt-badge{display:none} /* hide badge on very small screens to keep layout tidy */
    }

    /* print styles for invoice (when printing the page) */
    @media print{
      body{background:white}
      .topbar,.layout > aside,.top-actions,footer{display:none}
      .container{margin:0;padding:0}
    }

    /* subtle animations */
    .fade-up{transform:translateY(8px);opacity:0;transition:all 420ms cubic-bezier(.22,.9,.32,1)}
    .fade-up.in{transform:none;opacity:1}

    /* accessibility helpers */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* footer */
    footer{margin-top:24px;padding:18px;text-align:center;color:var(--muted);font-size:13px}

    /* large screen layout improvements */
    @media (min-width:1200px){
      .container{padding:28px}
    }

    /* helper utilities */
    .muted-2{color:#6b7280}
    .label-strong{font-weight:800}

  </style>
</head>
<body>

  <div class="container">
    <!-- TOPBAR -->
    <div class="topbar" role="banner">
      <div class="brand">
        <div class="mark" aria-hidden="true">üåà</div>
        <div>
          <h1>Rainbow School</h1>
          <p class="muted">Healthy school ‚Äî Healthy kids</p>
        </div>
      </div>

      <div class="top-actions">
        <div class="chip" aria-hidden="true">üìç Venkatagiri</div>
        <div class="phone" aria-label="Support phone">+91 94924 00555</div>
        <div class="contact muted-2">Mon‚ÄìFri 9:00‚Äì17:30</div>
        <!-- Visible receipt badge (keeps in sync with the hidden/readonly input) -->
        
      </div>
    </div>

    <!-- LAYOUT (Left: info / Right: payment) -->
    <div class="layout" role="main">

      <!-- LEFT: school info, vision, leaders, downloads -->
      <section class="card school-info" aria-labelledby="about-heading">
        <div style="flex:0 0 120px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:12px">
          <img src="https://play-lh.googleusercontent.com/OWAvW8dz5YLwz2OVxDEoyY28EkiUIP1C0PPmN7kpHlibYi0SeJl0AR4BQG2j565G5Q" alt="Rainbow School logo" style="width:96px;height:96px;border-radius:18px;object-fit:cover;box-shadow:0 8px 24px rgba(8,32,64,0.08)" />
          <div style="text-align:center">
            <div style="font-weight:800">Rainbow School</div>
            <div class="muted" style="font-size:13px">Venkatagiri, SPSR Nellore</div>
          </div>
        </div>

        <div class="school-body">
          <h2 id="about-heading">About the School</h2>
          <p class="muted">Rainbow School is a recognized landmark in its pursuit of excellence in education and the holistic development of children. We blend modern pedagogy with community values.</p>

          <div style="margin-top:14px" class="meta-list">
            <div class="meta">Academic Excellence</div>
            <div class="meta">Sports & Hobbies</div>
            <div class="meta">Community Service</div>
            <div class="meta">Eco Initiatives</div>
          </div>

          <div style="margin-top:18px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
            <div class="card" style="padding:12px">
              <h3 style="margin:0 0 6px 0">Vision & Mission</h3>
              <p class="muted" style="margin:0">To be an institute of global repute shaping future-ready citizens through values and innovation.</p>
            </div>

            <div class="card" style="padding:12px">
              <h3 style="margin:0 0 6px 0">Leadership</h3>
              <p class="muted" style="margin:0">Led by educators with decades of experience ‚Äî we focus on mentorship and curiosity-driven learning.</p>
            </div>

            <div class="card" style="padding:12px">
              <h3 style="margin:0 0 6px 0">Parent's Speak</h3>
              <blockquote style="margin:0;font-style:italic;color:#0f172a;">"We want our students to be risk-takers and to try new things in life."</blockquote>
            </div>


          </div>

          <div style="margin-top:18px" class="card">
            <h3 style="margin:0 0 6px 0">Contact & Address</h3>
            <address class="muted" style="font-style:normal;margin:0">
              Venkatagiri, S.P.S.R Nellore District,<br />
              Andhra Pradesh - PIN 524132<br />
              Email: <a href="mailto:mail@rainbowschoolvenkatagiri.com">mail@rainbowschoolvenkatagiri.com</a><br />
              Phones: +91 9492400555, +91 9490716961
            </address>
          </div>

        </div>
      </section>


      <!-- RIGHT: Payment / Invoice Panel -->
      <aside class="payment-panel">
        <div class="card" role="region" aria-labelledby="pay-heading">
          <h2 id="pay-heading">Fee Payment</h2>
          <div class="muted">Choose your method and complete the payment. A downloadable invoice will be available after success.</div>

          <form id="paymentForm" autocomplete="off" novalidate style="margin-top:12px">

            <div class="field">
              <label for="receiptNo">Receipt No. <span class="muted" style="font-weight:600"></span></label>
              <input id="receiptNo" name="receiptNo" type="text" value="" readonly aria-readonly="true" />
            </div>

            <div class="row">
              <div class="col field">
                <label for="payDate">Payment Date</label>
                <input id="payDate" name="payDate" type="date" />
              </div>
              <div class="col field">
                <label for="amount">Amount (INR)</label>
                <input id="amount" name="amount" type="number" min="0" step="0.01" inputmode="decimal" placeholder="e.g. 3500.00" aria-label="Amount in rupees" />
              </div>
            </div>

            <div class="field">
              <label for="studentName">Student Name</label>
              <input id="studentName" name="studentName" type="text" placeholder="Enter student name" />
            </div>

            <div class="row">
              <div class="col field">
                <label for="classSelect">Class</label>
                <select id="classSelect" name="classSelect" aria-label="Class">
                  <option value="">Select class</option>
                  <option>Nursery</option>
                  <option>KG</option>
                  <option>Class 1</option>
                  <option>Class 2</option>
                  <option>Class 3</option>
                  <option>Class 4</option>
                  <option>Class 5</option>
                  <option>Class 6</option>
                  <option>Class 7</option>
                  <option>Class 8</option>
                  <option>Class 9</option>
                  <option>Class 10</option>
                </select>
              </div>

              <div class="col field">
                <label for="sectionSelect">Section</label>
                <select id="sectionSelect" name="sectionSelect" aria-label="Section">
                  <option value="">Section</option>
                  <option>A</option>
                  <option>B</option>
                  <option>C</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label for="payerInput">Parent / Payer</label>
              <input id="payerInput" name="payerInput" type="text" placeholder="Enter payer / parent's name" />
            </div>

            <div class="field">
              <label>Payment Method</label>
              <div class="payment-methods" id="methods" role="tablist" aria-label="Payment methods">
                <button type="button" class="pm active" data-method="razorpay" role="tab" aria-selected="true">Razorpay</button>
                <button type="button" class="pm" data-method="upi" role="tab" aria-selected="false">UPI</button>
                <button type="button" class="pm" data-method="cash" role="tab" aria-selected="false">Cash</button>
              </div>
              <div id="methodHint" class="small muted" style="margin-top:8px">Razorpay (recommended) ‚Äî will open secure checkout in test mode.</div>
            </div>

            <!-- UPI / QR holder -->
            <div id="upiBox" style="display:none;margin-top:10px">
              <div class="qr-box" role="region" aria-label="UPI payment box">
                <div style="font-weight:800;margin-bottom:8px">UPI Payment</div>
                <div class="small muted">UPI ID: <strong>rainbowschool@upi</strong></div>
                <div class="small muted">Use any UPI app to pay or scan the QR.</div>
                <div style="margin-top:8px;display:flex;gap:8px;justify-content:center">
                  <button type="button" class="btn btn-ghost" id="simulateUpiBtn">Simulate UPI Paid</button>
                  <button type="button" class="btn btn-ghost" id="downloadQrBtn">Download QR</button>
                </div>
              </div>
            </div>

            <!-- Cash -->
            <div id="cashBox" style="display:none;margin-top:10px">
              <div class="qr-box" role="region" aria-label="Cash payment box">
                <div style="font-weight:800;margin-bottom:8px">Cash Payment</div>
                <div class="small muted">Collect cash at the school office or mark as paid below.</div>
                <div style="margin-top:8px;display:flex;gap:8px;justify-content:center">
                  <button type="button" class="btn btn-ghost" id="markCashBtn">Mark as Paid (Cash)</button>
                </div>
              </div>
            </div>

            <div style="display:flex;gap:10px;justify-content:space-between;align-items:center;margin-top:12px">
              <div class="small muted">Secure payment powered by trusted providers</div>
              <div style="display:flex;gap:8px">
                <button type="button" class="btn btn-ghost" id="resetBtn">Reset</button>
                <button type="button" class="btn btn-primary" id="payBtn">Pay Now</button>
              </div>
            </div>

            <div id="result" aria-live="polite" style="margin-top:12px"></div>

            <div id="invoiceActions" style="display:none;margin-top:12px">
              <div class="invoice-ready" role="status">Payment succeeded ‚Äî Invoice ready</div>
              <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
                <button type="button" class="btn btn-ghost" id="viewInvoiceBtn">View Invoice (Print)</button>
              </div>
            </div>

          </form>
        </div>

        <div style="height:14px"></div>


      </aside>

    </div>

    <footer>
      All rights reserved ¬© 2025 ‚Ä¢ Legal Notice ‚Ä¢ Privacy & Cookie Policy ‚Ä¢ Developed by VisionExt
    </footer>
  </div>

  <script>
    /* ==========================================================
       JavaScript: interactions, payment simulation, invoice generation
       Features:
         - responsive-friendly controls
         - accessible toggles
         - Razorpay integration (demo/test key)
         - jsPDF invoice download & print
         - QR download simulation
         - client-side validation & UX polish
       ========================================================== */

    (function(){
      // Elements
      const dateEl = document.getElementById('payDate');
      const receiptEl = document.getElementById('receiptNo');
      const receiptBadgeText = document.getElementById('receiptBadgeText');
      const amountEl = document.getElementById('amount');
      const studentEl = document.getElementById('studentName');
      const classEl = document.getElementById('classSelect');
      const sectionEl = document.getElementById('sectionSelect');
      const payerEl = document.getElementById('payerInput');
      const methodsWrap = document.getElementById('methods');
      const methodEls = methodsWrap.querySelectorAll('.pm');
      const methodHint = document.getElementById('methodHint');
      let selectedMethod = 'razorpay';

      // invoice actions
      const resultBox = document.getElementById('result');
      const invoiceActions = document.getElementById('invoiceActions');

      // Setup defaults
      function init(){
        // date
        if(!dateEl.value) dateEl.value = new Date().toISOString().slice(0,10);
        populateRandomReceipt();

        // clear important fields
        amountEl.value = '';
        studentEl.value = '';
        classEl.value = '';
        sectionEl.value = '';
        payerEl.value = '';

        // method handlers
        methodEls.forEach(btn=>{
          btn.addEventListener('click', ()=>{
            methodEls.forEach(x=>x.classList.remove('active'));
            methodEls.forEach(x=>x.setAttribute('aria-selected','false'));
            btn.classList.add('active');
            btn.setAttribute('aria-selected','true');
            selectedMethod = btn.dataset.method;
            updateMethodUI();
          });
          // keyboard support
          btn.addEventListener('keydown', (e)=>{
            if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); }
          });
        });

        updateMethodUI();
      }

      function populateRandomReceipt(){
        const now = new Date();
        const year = now.getFullYear();
        // generate a random numeric suffix and an internal segment for a more "random" but recognizable receipt format
        const segmentA = Math.floor(100 + Math.random()*900); // 3-digit
        const segmentB = Math.floor(100000 + Math.random()*900000); // 6-digit
        const receipt = `SR-${year}-${segmentA}-${segmentB}`;
        // set the readonly input and the visible badge in topbar, keeping both in sync
        receiptEl.value = receipt;
        if(receiptBadgeText) receiptBadgeText.textContent = receipt;
      }

      function updateMethodUI(){
        document.getElementById('upiBox').style.display = selectedMethod === 'upi' ? 'block' : 'none';
        document.getElementById('cashBox').style.display = selectedMethod === 'cash' ? 'block' : 'none';
        if(selectedMethod === 'razorpay') methodHint.textContent = 'Razorpay (recommended) ‚Äî will open secure checkout in test mode.';
        if(selectedMethod === 'upi') methodHint.textContent = 'Pay using your UPI app to the provided UPI ID. Then click "Simulate UPI Paid".';
        if(selectedMethod === 'cash') methodHint.textContent = 'Mark cash paid at the office or use "Mark as Paid (Cash)".';
      }

      // Reset
      document.getElementById('resetBtn').addEventListener('click', ()=>{
        populateRandomReceipt();
        amountEl.value = '';
        studentEl.value = '';
        classEl.value = '';
        sectionEl.value = '';
        payerEl.value = '';
        dateEl.value = new Date().toISOString().slice(0,10);
        // reset method
        selectedMethod = 'razorpay';
        methodEls.forEach(x=>x.classList.remove('active'));
        methodEls[0].classList.add('active');
        methodEls.forEach(x=>x.setAttribute('aria-selected','false'));
        methodEls[0].setAttribute('aria-selected','true');
        updateMethodUI();
        hideResult();
      });

      // Pay button
      document.getElementById('payBtn').addEventListener('click', handlePay);

      // UPI simulate
      document.getElementById('simulateUpiBtn').addEventListener('click', ()=>{
        onPaymentSuccess({ method: 'UPI', payment_id: 'UPI-' + Date.now(), order_id: 'ORDER-' + Date.now() });
      });

      // Download QR (demo: create simple canvas QR-like image)
      document.getElementById('downloadQrBtn').addEventListener('click', ()=>{
        try{
          const canvas = document.createElement('canvas');
          canvas.width = 800; canvas.height = 800;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.fillStyle = '#0f172a';
          ctx.fillRect(80,80,640,640);
          ctx.fillStyle = '#fff';
          ctx.font = 'bold 40px Inter';
          ctx.fillText('RAINBOW', 240, 420);
          const url = canvas.toDataURL('image/png');
          const a = document.createElement('a');
          a.href = url; a.download = 'rainbowschool_upi_qr.png'; a.click();
        }catch(e){alert('Unable to generate QR image in this browser.');}
      });

      // Mark cash paid
      document.getElementById('markCashBtn').addEventListener('click', ()=>{
        onPaymentSuccess({ method: 'Cash', payment_id: 'CASH-' + Date.now(), order_id: 'ORDER-' + Date.now() });
      });

      // validate basic fields
      function validate(){
        const amount = Number(amountEl.value);
        if(!amount || isNaN(amount) || amount <= 0){ showAlert('Enter a valid amount'); return false; }
        // optionally require payer or student
        if(!studentEl.value.trim()){ if(!confirm('No student name provided. Continue?')) return false; }
        return true;
      }

      function showAlert(msg){ alert(msg); }

      function handlePay(){
        if(!validate()) return;
        if(selectedMethod === 'razorpay'){
          startRazorpay(Number(amountEl.value));
        } else if(selectedMethod === 'upi'){
          document.getElementById('upiBox').scrollIntoView({behavior:'smooth'});
          alert('UPI selected. Use your UPI app to pay to the UPI ID shown, then click "Simulate UPI Paid".');
        } else if(selectedMethod === 'cash'){
          document.getElementById('cashBox').scrollIntoView({behavior:'smooth'});
          alert('Cash selected. Visit school office or click "Mark as Paid (Cash)".');
        }
      }

      /* ---------- Razorpay integration (demo test) ---------- */
      function startRazorpay(amountINR){
        const amountPaise = Math.round(amountINR * 100);
        const options = {
          key: "rzp_test_1DP5mmOlF5G5ag",
          amount: amountPaise,
          currency: "INR",
          name: "Rainbow School",
          description: "Fee Payment",
          prefill: {
            name: payerEl.value || '',
            email: '',
            contact: ''
          },
          handler: function (response){
            onPaymentSuccess({ method: 'Razorpay', payment_id: response.razorpay_payment_id || ('RPAY-' + Date.now()), order_id: response.razorpay_order_id || ('ORDER-' + Date.now()), raw: response });
          },
          modal: { ondismiss: function(){ showResult('Payment cancelled or dismissed'); } },
          theme: { color: "#0f62fe" }
        };

        try{
          const rzp = new Razorpay(options);
          rzp.open();
        }catch(e){
          console.warn('Razorpay open failed', e);
          // fallback simulation
          setTimeout(()=> onPaymentSuccess({ method:'Razorpay', payment_id: 'RPAY-' + Date.now(), order_id:'ORDER-' + Date.now() }), 600);
        }
      }

      /* ---------- After payment success ---------- */
      function onPaymentSuccess(data){
        const receiptNo = receiptEl.value || ('SR-' + Date.now());
        const payDate = dateEl.value || new Date().toISOString().slice(0,10);
        const studentName = studentEl.value || '';
        const studentClass = classEl.value || '';
        const section = sectionEl.value ? ('Section ' + sectionEl.value) : '';
        const parentName = (payerEl.value || '').trim();
        const amount = Number(amountEl.value) || 0;

        const txn = {
          receiptNo,
          payDate,
          studentName,
          studentClass: (studentClass ? studentClass : '') + (section ? ' ‚Ä¢ ' + section : ''),
          parentName,
          amount,
          method: data.method || selectedMethod,
          paymentId: data.payment_id || ('PAY-' + Date.now()),
          orderId: data.order_id || ('ORD-' + Date.now())
        };

        window.__LAST_TXN = txn;
        showResult('Payment successful: ' + txn.method + ' ‚Ä¢ Transaction ID: ' + txn.paymentId, true);

        // For corporate UX: store locally for quick retrieval (not secure), can be extended to hit backend
        try{ localStorage.setItem('rainbow_last_txn', JSON.stringify(txn)); }catch(e){}
      }

      function getPayerValue(){ return (payerEl.value || '').trim(); }

      function showResult(msg, success){
        resultBox.innerHTML = `<div style="padding:12px;border-radius:10px;background:${success ? '#f0fff4' : '#fff6f6'};border:1px solid ${success ? '#e6f8ed' : '#f4d7d7'};color:${success ? '#0b7130' : '#7a1f1f'}">${escapeHtml(msg)}</div>`;
        if(success) invoiceActions.style.display = 'block'; else invoiceActions.style.display = 'none';
      }

      function hideResult(){ resultBox.innerHTML = ''; invoiceActions.style.display = 'none'; window.__LAST_TXN = null; }

      // small helper
      function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>\"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','"':'&quot;',"'":'&#039;'}[m]; }); }

      // invoice UI
      document.getElementById('viewInvoiceBtn').addEventListener('click', ()=>{
        const txn = window.__LAST_TXN || JSON.parse(localStorage.getItem('rainbow_last_txn') || 'null');
        if(!txn){ alert('No invoice available. Complete a payment first.'); return; }
        openInvoicePrint(txn);
      });

      document.getElementById('downloadPdfBtn')?.addEventListener('click', async ()=>{
        const txn = window.__LAST_TXN || JSON.parse(localStorage.getItem('rainbow_last_txn') || 'null');
        if(!txn){ alert('No invoice available. Complete a payment first.'); return; }
        await downloadInvoicePdf(txn);
      });

      // Print view
      function openInvoicePrint(txn){
        const html = generateInvoiceHtml(txn);
        const w = window.open('', '_blank');
        w.document.write(html);
        w.document.close();
        // Wait for render then print
        w.onload = function(){ setTimeout(()=>{ w.print(); }, 350); };
      }

      // Invoice HTML generator (print-friendly corporate style)
      function generateInvoiceHtml(txn){
        const total = Number(txn.amount).toFixed(2);
        const date = txn.payDate;
        return `<!doctype html>
          <html>
          <head>
            <meta charset="utf-8" />
            <title>Rainbow School Invoice ${txn.receiptNo}</title>
            <meta name="viewport" content="width=device-width,initial-scale=1" />
            <style>
              @media print{ body{zoom:0.95} }
              body{font-family: Poppins, Inter, sans-serif;margin:0;color:#0b2540}
              .wrap{max-width:760px;margin:20px auto;padding:26px;border-radius:10px;border:1px solid #e6eefb}
              .header{display:flex;justify-content:space-between;align-items:center}
              .brand{font-size:20px;font-weight:800;color:#0f62fe}
              .meta{font-size:13px;color:#6b7280}
              table{width:100%;border-collapse:collapse;margin-top:18px}
              th,td{padding:12px 8px;border-bottom:1px solid #eef2f6;text-align:left}
              th{color:#0f62fe;font-weight:700;width:40%}
              .total{background:#ecfdf5;color:#047857;font-weight:700;border-radius:8px;padding:8px}
              .footer{margin-top:20px;font-size:13px;color:#475569;text-align:center}
            </style>
          </head>
          <body>
            <div class="wrap">
              <div class="header">
                <div>
                  <div class="brand">üåà Rainbow School</div>
                  <div class="meta">Venkatagiri, Andhra Pradesh</div>
                </div>
                <div style="text-align:right">
                  <div style="font-weight:700">Receipt: ${txn.receiptNo}</div>
                  <div class="meta">Date: ${date}</div>
                </div>
              </div>

              <h2 style="color:#0f172a;margin-top:18px;margin-bottom:6px">Payment Receipt</h2>
              <div class="meta">Rainbow School ‚Äî Fee Payment Confirmation</div>

              <table role="presentation">
                <tr><th>Student</th><td>${escapeHtml(txn.studentName)} ${txn.studentClass ? '('+escapeHtml(txn.studentClass)+')' : ''}</td></tr>
                <tr><th>Payer</th><td>${escapeHtml(txn.parentName)}</td></tr>
                <tr><th>Payment Method</th><td>${escapeHtml(txn.method)}</td></tr>
                <tr><th>Transaction ID</th><td>${escapeHtml(txn.paymentId)}</td></tr>
                <tr><th>Order ID</th><td>${escapeHtml(txn.orderId)}</td></tr>
                <tr><th class="total">Total Paid (INR)</th><td class="total">‚Çπ ${Number(txn.amount).toLocaleString('en-IN', {minimumFractionDigits:2})}</td></tr>
              </table>

              <p class="footer">This is a computer generated receipt and does not require a signature. Keep this document for your records.</p>
            </div>
          </body>
          </html>`;
      }

      // Download PDF function via jsPDF (simple formatted PDF)
      async function downloadInvoicePdf(txn){
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({unit:'pt', format:'a4'});
        const left = 40; let y = 40;
        doc.setFontSize(18); doc.setFont('helvetica','bold'); doc.text('Rainbow School', left, y);
        y += 22; doc.setFontSize(11); doc.setFont('helvetica','normal'); doc.text('Venkatagiri, Andhra Pradesh', left, y);
        y += 20; doc.setFontSize(12); doc.setFont('helvetica','bold'); doc.text('Payment Receipt', left, y);
        y += 18;

        function addLine(label, value){ doc.setFont('helvetica','bold'); doc.text(label, left, y); doc.setFont('helvetica','normal'); doc.text(String(value), left + 180, y); y += 16; }

        addLine('Receipt No.:', txn.receiptNo);
        addLine('Date:', txn.payDate);
        addLine('Student:', txn.studentName + (txn.studentClass ? ' (' + txn.studentClass + ')' : ''));
        addLine('Payer:', txn.parentName);
        addLine('Method:', txn.method);
        addLine('Transaction ID:', txn.paymentId);
        addLine('Order ID:', txn.orderId);
        y += 6; doc.setFont('helvetica','bold'); doc.text('Total Paid (INR):', left, y); doc.text('‚Çπ ' + Number(txn.amount).toLocaleString('en-IN', {minimumFractionDigits:2}), left + 180, y);
        y += 32;
        doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.text('This is a computer generated receipt and does not require a signature.', left, y);

        const filename = `Invoice_${txn.receiptNo || Date.now()}.pdf`;
        doc.save(filename);
      }

      // small utility to persist txn and load last
      try{
        const last = JSON.parse(localStorage.getItem('rainbow_last_txn') || 'null');
        if(last){ window.__LAST_TXN = last; invoiceActions.style.display = 'none'; }
      }catch(e){}

      // tiny UX: reveal animations
      setTimeout(()=>{ document.querySelectorAll('.fade-up').forEach(el=>el.classList.add('in')); }, 250);

      // Initialize
      init();

    })();

  </script>

</body>
</html>
